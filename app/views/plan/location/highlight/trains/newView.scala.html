@import helper._


@(
user: models.auth.User,
token: String,
stations: List[models.location.Location],
formData: List[Map[String, (String, String)]],
callingPoints: List[models.location.MapLocation],
notCalledAt: List[models.location.MapLocation],
highlightPoints: List[models.location.MapLocation],
messages: List[String],
formSubmitRoute: Call
)(implicit request: Request[AnyContent])
@templates.main("Highlight Trains", "Plan",  Some(user)){

<style>
    td{
        display:block;
    }

</style>

<script type="text/javascript">
    const token = "@token";

</script>

@if(messages.size > 0){
<div class="alert alert-primary">
    <h2>Messages</h2>
    <ul>
        @for(message <- messages){
        <li>@message</li>
        }
    </ul>
</div>
}

@helper.form(action = formSubmitRoute) {
@helper.CSRF.formField
<div class="row">
    <div class="col col-sm">

        <datalist id="stations">
            @for(s <- stations) {
            <option value="@s.name">@s.name [@s.id] [@s.crs.mkString]</option>
            }
        </datalist>
        <div id="container">
            @for(data <- formData){

            @data
            <div class="row">
                <div class="col col-sm">
                    <div class="form-group">
                        <label for='@data("date")._1'>Date</label>
                        <input id='@data("date")._1' name='@data("date")._1' class="form-control" type="date" value='@data("date")._2'>

                        <label for='@data("location")._1'>Location to Search for Trains at</label>
                        <input id='@data("location")._1' name='@data("location")._1' class="form-control location" list="stations"
                               onchange="addLocation(this)" onfocusout="addLocationSuggestion(this)" value='@data("location")._2'/>

                        <label for='@data("trainId")._1'>Train ID</label>
                        <datalist id="datalist-0"></datalist>
                        <input id='@data("trainId")._1' name='@data("trainId")._1' class="form-control train-id" type="text"
                               onchange="addTrain(this)" onfocusout="addTrain(this)" list="datalist-0" value='@data("trainId")._2'>

                        <label for='@data("board")._1'>Board At</label>
                        <select id='@data("board")._1' name='@data("board")._1' class="form-control">
                            <option>@data("board")._2</option>
                        </select>

                        <label for='@data("alight")._1'>Alight At</label>
                        <select id='@data("alight")._1' name='@data("board")._1' class="form-control">
                            <option>@data("alight")._2</option>
                        </select>

                        <a role="button" class="btn btn-danger remove"><span class="text-light">Remove</span></a>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>
<div class="row">
    <div class="col col-sm">
        <div class="card-body">
            <a role="button" class="btn btn-secondary add"><span class="text-light">Add Train</span></a>
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
    </div>
</div>
<input type="hidden" id="serialized" name="serialized"/>
}

<div class="row">
    <div id="content-placeholder"></div>


    <template>
        <div class="alert alert-light alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <span class="title">
                <slot name="info"></slot>
            </span>
            <span id="tocBadge" class="badge badge-danger">
                <slot name="tocBadge"></slot>
            </span>
            <span id="typeBadge" class="badge badge-secondary">
                <slot name="type"></slot>
            </span><br/>
            <slot name="data" id="data" style="display: none"></slot>
            <a href="" target="_blank">More Details</a>
            <span id="visit-form" style="display:none"><span id="location"></span><span id="visit"></span></span>
        </div>
    </template>

    <template class="train-table-row">

        <div class="row">
            <div class="col col-sm">
                <div class="form-group">
                    <label id="date-label" for="date">Date</label>
                    <input id="date" name="date" class="form-control" type="date">

                    <label id="location-label" for="location">Search for Trains at this Location</label>
                    <input id="location" name="location" class="form-control location" list="stations"
                           onchange="addLocation(this)" onfocusout="addLocationSuggestion(this)"/>

                    <label id="train-label" for="train-id">Train ID</label>
                    <datalist id="datalist"></datalist>
                    <input id="train-id" name="train-id" class="form-control train-id" type="text"
                           onchange="addTrain(this)" onfocusout="addTrain(this)" list="datalist-0">

                    <label id="board-label" for="board">Board At</label>
                    <select id="board" name="board" class="form-control" disabled="disabled"></select>

                    <label id="alight-label" for="alight">Alight At</label>
                    <select id="alight" name="alight" class="form-control" disabled="disabled"></select>

                    <a role="button" class="btn btn-danger remove" onclick="removeRow(this)"><span class="text-light">Remove</span></a>
                </div>
            </div>
        </div>
    </template>

</div>
<div class="row">
    <div class="col col-sm">
        <div id="map" class="map"></div>
    </div>

</div>


<script type="text/javascript">
createMap();

function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}

@for(loc <- callingPoints) {
    addLocation({
        "location": {
            "lat": @loc.location.lat,
            "lon": @loc.location.lon
        },
        "name":'@loc.name',
        "id": '@loc.id',
        "operator": '@loc.operator',
        "visited": true
    });
}
 @for(loc <- highlightPoints) {
    addLocation({
        "location": {
            "lat": @loc.location.lat,
            "lon": @loc.location.lon
        },
        "name":'@loc.name',
        "id": '@loc.id',
        "operator": '@loc.operator',
        "visited": false
    });
}

registerMapHandler(map);

 $('.remove').click(function(){
        console.log("remove");
        removeRow(this);
    });

    function removeRow(el){
        $(el).parent().parent().remove();
    }

 $('.add').click(function(){
        console.log("add");
        var rowNumber = uuidv4();
        var container = document.querySelector("#container");
        var template = document.querySelector('.train-table-row');


        var clone = template.content.cloneNode(true);
        container.appendChild(clone);

        document.getElementById("date").name = "date_" + rowNumber;
        document.getElementById("datalist").name = "datalist_" + rowNumber;
        document.getElementById("location").name = "location_" + rowNumber;
        document.getElementById("train-id").name = "train-id_" + rowNumber;
        document.getElementById("board").name = "board_" + rowNumber;
        document.getElementById("alight").name = "alight_" + rowNumber;

        document.getElementById("date-label").setAttribute("for","date-label_" + rowNumber);
        document.getElementById("location-label").setAttribute("for","location-label_" + rowNumber);
        document.getElementById("train-label").setAttribute("for","train-id-label_" + rowNumber);
        document.getElementById("board-label").setAttribute("for","board-label_" + rowNumber);
        document.getElementById("alight-label").setAttribute("for","alight-label_" + rowNumber);

        document.getElementById("date-label").setAttribute("id","date-label_" + rowNumber);
        document.getElementById("location-label").setAttribute("id","location-label_" + rowNumber);
        document.getElementById("train-label").setAttribute("id","train-id-label_" + rowNumber);
        document.getElementById("board-label").setAttribute("id","board-label_" + rowNumber);
        document.getElementById("alight-label").setAttribute("id","alight-label_" + rowNumber);

        document.getElementById("date").id = "date_" + rowNumber;
        document.getElementById("datalist").id = "datalist_" + rowNumber;
        document.getElementById("location").id = "location_" + rowNumber;
        document.getElementById("train-id").setAttribute("list", "datalist_" + rowNumber);
        document.getElementById("train-id").id = "train-id_" + rowNumber;
        document.getElementById("board").id = "board_" + rowNumber;
        document.getElementById("alight").id = "alight_" + rowNumber;

    });

function addLocationSuggestion(element){

        var $this=$(element);

        var location = $this.parent().parent().find('.location')[0].value;
        var datalist = $this.parent().parent().find('datalist')[0];
        var date = $this.parent().parent().find('input[type=date]').val();

         jQuery.when(
            jQuery.ajax({
              url: "/api/plan/highlight/trains/location/" + location + "/" + date,
              headers: { "Authorization": "Bearer " + token }
            })

        )
        .done(function(timetable){

            var json = JSON.parse(timetable);

            datalist.options.length = 0;

            json.forEach(function(t) {
                var option = document.createElement("option");
                option.text=t.uid + " - " + t.org + " to " + t.dst + " - Pfm.: " + t.pfm + " Arrives: " + t.arr + " Departs: " + t.dep;
                option.value=t.uid;
                datalist.appendChild(option);

            });

        });
}

function addTrain(element){
        var $this=$(element);

        var selects = $this.parent().parent().find('select');
        var board = selects[0];
        var alight = selects[1];

        console.log("disabling selects")

        board.setAttribute("disabled", "disabled");
        alight.setAttribute("disabled", "disabled");

        board.options.length = 0;
        alight.options.length = 0;

        var date = $this.parent().parent().find('input[type=date]').val()
        var trainId = $this.val();


         jQuery.when(
            jQuery.ajax({
              url: "/api/plan/highlight/trains/callingpoints/" + trainId + "/" + date,
              headers: { "Authorization": "Bearer " + token }
            })

        )
        .done(function(timetable){
            console.log("enabling selects");

            var json = JSON.parse(timetable);
            var depOptions = json.map(function(t) {
                if(t.type !== "Origin") {
                    var option = document.createElement("option");
                    option.text=t.name + " - " + t.dep;
                    option.value=t.tiploc;
                    return option;
                }
            });

            var arrOptions = json.map(function(t) {
                if(t.type !== "Terminus"){
                    var option = document.createElement("option");
                    option.text=t.name + " - " + t.arr;
                    option.value=t.tiploc;
                    return option;
                }
            });



            board.removeAttribute("disabled");
            alight.removeAttribute("disabled");

            depOptions.forEach(function(option){
                if(option !== undefined){
                    board.add(option);
                }
            });
            arrOptions.forEach(function(option){
                if(option !== undefined){
                    alight.add(option);
                }
            });


        });
}



</script>
}